{% extends 'layout.html' %}
{% block content %}
<div class="card">
  <h2>ğŸ“š æ•™å­¦å¤§çº²è‡ªåŠ¨ç”Ÿæˆ</h2>
  <p class="tip">å¡«å†™åŸºæœ¬ä¿¡æ¯ï¼ŒAIå°†è‡ªåŠ¨ç”Ÿæˆå®Œæ•´çš„æ•™å­¦å¤§çº²å†…å®¹ã€‚æ”¯æŒè‡ªå®šä¹‰é‡ç‚¹æ¨¡å—å’Œæ’é™¤é¡¹ã€‚</p>
  
  <!-- åŸºæœ¬ä¿¡æ¯è¡¨å• -->
  <form id="outline-form">
    <div class="field">
      <label>è¯¾ç¨‹åç§° <span style="color:red;">*</span></label>
      <input type="text" id="course_name" placeholder="ä¾‹å¦‚ï¼šè®¡ç®—æœºç½‘ç»œåŸºç¡€" required />
    </div>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
      <div class="field">
        <label>ç¼–å†™æ—¥æœŸ</label>
        <input type="text" id="write_date" placeholder="ä¾‹å¦‚ï¼š2024å¹´3æœˆ" />
        <div class="tip">ç•™ç©ºå°†è‡ªåŠ¨ä½¿ç”¨å½“å‰å¹´æœˆ</div>
      </div>
      
      <div class="field">
        <label>è€ƒæ ¸æ–¹å¼åŠæˆç»©è¯„å®šåŠæ³•</label>
        <input type="text" id="assessment_method" placeholder="ä¾‹å¦‚ï¼šå¹³æ—¶30% + æœŸä¸­30% + æœŸæœ«40%" />
      </div>
    </div>
    
    <!-- AIç”Ÿæˆè®¾ç½® -->
    <div class="field">
      <label>ğŸ¤– AIç”Ÿæˆè®¾ç½®</label>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-top:8px;">
        <div>
          <span style="font-size:12px; color:#666; display:block; margin-bottom:4px;">å¤§æ¨¡å‹ï¼š</span>
          <select id="llm_provider" style="width:100%;">
            <option value="">ç¦»çº¿æ¨¡å¼ï¼ˆä½¿ç”¨é»˜è®¤æ¨¡æ¿ï¼‰</option>
            <option value="deepseek">DeepSeek</option>
            <option value="openai">OpenAI (ChatGPT)</option>
          </select>
        </div>
        <div>
          <span style="font-size:12px; color:#666; display:block; margin-bottom:4px;">API Keyï¼š</span>
          <input type="password" id="llm_api_key" placeholder="é€‰æ‹©æ¨¡å‹æ—¶å¿…å¡«" style="width:100%;" />
        </div>
        <div>
          <span style="font-size:12px; color:#666; display:block; margin-bottom:4px;">æ¨¡å‹åç§°ï¼š</span>
          <input type="text" id="llm_model" placeholder="å¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤" style="width:100%;" />
        </div>
      </div>
    </div>
    
    <!-- AIç”Ÿæˆç²¾ç»†æ§åˆ¶è®¾ç½® -->
    <div class="field" style="margin-top:20px; padding:20px; background:#f8f9fa; border-radius:8px; border-left:4px solid #4CAF50;">
      <label style="font-size:16px; margin-bottom:15px; display:flex; align-items:center;">
        <span>ğŸ›ï¸ AIç”Ÿæˆç²¾ç»†æ§åˆ¶</span>
        <span style="font-size:12px; color:#666; margin-left:10px; font-weight:normal;">ï¼ˆè®¾ç½®AIç”Ÿæˆçš„åŸºè°ƒã€è§„åˆ™å’Œä¾§é‡ç‚¹ï¼‰</span>
      </label>
      
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:15px;">
        <div class="field" style="margin-bottom:0;">
          <label style="font-size:14px; color:#e74c3c; margin-bottom:8px;">ğŸš« æ’é™¤é¡¹ï¼ˆä¸èƒ½å‡ºç°çš„å†…å®¹ï¼‰</label>
          <textarea id="exclude_items" rows="4" placeholder="ä¾‹å¦‚ï¼šäººå·¥æ™ºèƒ½ã€åŒºå—é“¾ã€é‡å­è®¡ç®—...&#10;æ˜ç¡®æŒ‡å®šä¸å¸Œæœ›åœ¨æ•™å­¦å¤§çº²ä¸­å‡ºç°çš„æŠ€æœ¯æˆ–å†…å®¹"></textarea>
          <div class="tip">AIå°†ä¸¥æ ¼é¿å…ç”Ÿæˆè¿™äº›å†…å®¹</div>
        </div>
        
        <div class="field" style="margin-bottom:0;">
          <label style="font-size:14px; color:#f39c12; margin-bottom:8px;">ğŸ’¡ ç”¨æˆ·æç¤ºè¯ï¼ˆç‰¹åˆ«çªå‡ºæ–¹å‘ï¼‰</label>
          <textarea id="user_prompt" rows="4" placeholder="ä¾‹å¦‚ï¼šçªå‡ºå·¥ç¨‹å®è·µèƒ½åŠ›ã€å¼ºåŒ–å›¢é˜Ÿåä½œã€æ³¨é‡åˆ›æ–°æ€ç»´åŸ¹å…»ã€å¯¹æ¥è¡Œä¸šæ ‡å‡†...&#10;åœ¨éµå¾ªåŸºè°ƒå’Œè§„åˆ™çš„åŸºç¡€ä¸Šï¼Œç‰¹åˆ«å¼ºè°ƒå’Œçªå‡ºçš„æ–¹é¢"></textarea>
          <div class="tip">åœ¨ç³»ç»ŸåŸºè°ƒåŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥æ˜ç¡®å¸Œæœ›ç‰¹åˆ«å¼ºè°ƒå’Œçªå‡ºçš„æ•™å­¦é‡ç‚¹</div>
        </div>
      </div>
      
      <div class="field" style="margin-bottom:0;">
        <label style="font-size:14px; color:#9b59b6; margin-bottom:8px;">âš™ï¸ ç³»ç»Ÿæç¤ºè¯ï¼ˆé‡ç‚¹åŠŸèƒ½æ¨¡å—ï¼‰</label>
        <textarea id="system_prompt" rows="4" placeholder="ä¾‹å¦‚ï¼šæ³¨é‡å®è·µæ€§ã€ç¬¦åˆä¼ä¸šéœ€æ±‚ã€çªå‡ºèŒä¸šæŠ€èƒ½åŸ¹å…»ã€éµå¾ªOBEæ•™å­¦ç†å¿µã€é‡ç‚¹æ¨¡å—ï¼šæ•°æ®åº“è®¾è®¡ã€ç½‘ç»œç¼–ç¨‹ã€ç³»ç»Ÿæ¶æ„...&#10;è®¾å®šAIç”Ÿæˆå†…å®¹çš„æ•´ä½“åŸºè°ƒã€æ•™å­¦ç†å¿µã€åŸºæœ¬è§„åˆ™å’Œé‡ç‚¹å…³æ³¨çš„åŠŸèƒ½æ¨¡å—"></textarea>
        <div class="tip">å®šä¹‰AIç”Ÿæˆå†…å®¹åº”è¯¥éµå¾ªçš„æ•™å­¦ç†å¿µã€é£æ ¼ã€åŸºæœ¬è¦æ±‚å’Œé‡ç‚¹åŠŸèƒ½æ¨¡å—</div>
      </div>
    </div>
    
    <!-- æ–°å¢ï¼šå­—æ•°æ§åˆ¶è®¾ç½® -->
    <div class="field" style="margin-top:15px; padding:15px; background:#f8f9fa; border-radius:6px;">
      <label>ğŸ“ å†…å®¹é•¿åº¦æ§åˆ¶</label>
      <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-top:8px;">
        <div>
          <span style="font-size:12px; color:#666;">è¯¾ç¨‹å®šä½å­—æ•°:</span>
          <input type="number" id="positioning_length" value="100" min="50" max="300" style="width:100%; padding:6px; margin-top:4px;" />
        </div>
        <div>
          <span style="font-size:12px; color:#666;">æ•™å­¦ç›®æ ‡å­—æ•°:</span>
          <input type="number" id="objectives_length" value="80" min="30" max="200" style="width:100%; padding:6px; margin-top:4px;" />
        </div>
        <div>
          <span style="font-size:12px; color:#666;">æ¨¡å—å†…å®¹å­—æ•°:</span>
          <input type="number" id="module_content_length" value="60" min="30" max="150" style="width:100%; padding:6px; margin-top:4px;" />
        </div>
      </div>
      <div class="tip" style="margin-top:8px;">æ§åˆ¶AIç”Ÿæˆæ¯ä¸ªéƒ¨åˆ†çš„å†…å®¹é•¿åº¦ï¼Œç¡®ä¿æ ¼å¼æ•´é½ç»Ÿä¸€</div>
    </div>
    
    <div style="text-align:center; margin-top:20px;">
      <button type="submit" class="btn" style="padding:12px 30px; font-size:16px;">
        ğŸš€ è‡ªåŠ¨ç”Ÿæˆæ•™å­¦å¤§çº²
      </button>
    </div>
  </form>
  
  <!-- ç”Ÿæˆè¿›åº¦ -->
  <div id="progress" style="display:none; text-align:center; margin-top:20px;">
    <div style="font-size:16px; color:#666; margin-bottom:10px;">
      <span id="progress-text">ğŸ¤– AIæ­£åœ¨ç”Ÿæˆæ•™å­¦å¤§çº²å†…å®¹...</span>
    </div>
    <div style="width:100%; background:#f0f0f0; border-radius:10px; overflow:hidden;">
      <div id="progress-bar" style="width:0%; height:6px; background:linear-gradient(90deg, #4CAF50, #45a049); transition:width 0.3s;"></div>
    </div>
  </div>
  
  <!-- ç”Ÿæˆç»“æœ -->
  <div id="result" style="display:none; margin-top:30px;">
    <h3>âœ… ç”Ÿæˆå®Œæˆ</h3>
    <div style="text-align:center; margin:20px 0;">
      <button id="preview-btn" class="btn" style="margin-right:10px;">ğŸ“‹ é¢„è§ˆå¤§çº²</button>
      <button id="generate-word-btn" class="btn" style="margin-right:10px; background:#28a745;">ğŸ“„ ç”ŸæˆWordæ–‡æ¡£</button>
      <button id="edit-btn" class="btn" style="margin-right:10px;">âœï¸ ç¼–è¾‘å†…å®¹</button>
      <button id="regenerate-btn" class="btn" style="background:#ff9800;">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
    </div>
    
    <!-- ç”Ÿæˆçš„æ•°æ®é¢„è§ˆ -->
    <div id="data-preview" style="display:none;">
      <h4>ğŸ“Š ç”Ÿæˆçš„æ•°æ®å†…å®¹</h4>
      <textarea id="generated-data" readonly style="width:100%; height:300px; font-family:monospace; font-size:12px;"></textarea>
    </div>
  </div>
</div>

<style>
.field {
  margin-bottom: 15px;
}

.field label {
  display: block;
  font-weight: bold;
  margin-bottom: 5px;
  color: #333;
}

.field input, .field select, .field textarea {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  box-sizing: border-box;
}

.field input:focus, .field select:focus, .field textarea:focus {
  outline: none;
  border-color: #4CAF50;
  box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
}

.tip {
  font-size: 12px;
  color: #666;
  margin-top: 4px;
}

.btn {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.3s;
}

.btn:hover {
  background: #45a049;
}

.btn:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.card {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  max-width: 1000px;
  margin: 0 auto;
}
</style>

<script>
(function() {
  const form = document.getElementById('outline-form');
  const progressDiv = document.getElementById('progress');
  const progressText = document.getElementById('progress-text');
  const progressBar = document.getElementById('progress-bar');
  const resultDiv = document.getElementById('result');
  const dataPreview = document.getElementById('data-preview');
  const generatedDataTextarea = document.getElementById('generated-data');
  
  let generatedData = {};
  
  // è®¾ç½®å½“å‰æ—¥æœŸä¸ºé»˜è®¤å€¼
  const now = new Date();
  const defaultDate = `${now.getFullYear()}å¹´${(now.getMonth() + 1).toString().padStart(2, '0')}æœˆ`;
  document.getElementById('write_date').value = defaultDate;
  
  // è¡¨å•æäº¤å¤„ç†
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const courseName = document.getElementById('course_name').value.trim();
    if (!courseName) {
      alert('è¯·è¾“å…¥è¯¾ç¨‹åç§°');
      return;
    }
    
    // æ˜¾ç¤ºè¿›åº¦
    progressDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    form.style.display = 'none';
    
    // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
    let progress = 0;
    const progressInterval = setInterval(() => {
      progress += Math.random() * 15;
      if (progress > 90) progress = 90;
      progressBar.style.width = progress + '%';
      
      if (progress < 30) {
        progressText.textContent = 'ğŸ¤– AIæ­£åœ¨åˆ†æè¯¾ç¨‹å†…å®¹...';
      } else if (progress < 60) {
        progressText.textContent = 'ğŸ“š æ­£åœ¨ç”Ÿæˆæ•™å­¦ç›®æ ‡å’Œå†…å®¹...';
      } else {
        progressText.textContent = 'âš™ï¸ æ­£åœ¨å®Œå–„æ•™å­¦å®‰æ’...';
      }
    }, 500);
    
    try {
      // å‡†å¤‡æ•°æ®
      const payload = {
        course_name: courseName,
        write_date: document.getElementById('write_date').value.trim(),
        assessment_method: document.getElementById('assessment_method').value.trim(),
        exclude_items: document.getElementById('exclude_items').value.trim(),
        // AIç²¾ç»†æ§åˆ¶å‚æ•°
        system_prompt: document.getElementById('system_prompt').value.trim(),
        user_prompt: document.getElementById('user_prompt').value.trim(),
        llm_provider: document.getElementById('llm_provider').value.trim(),
        llm_api_key: document.getElementById('llm_api_key').value.trim(),
        llm_model: document.getElementById('llm_model').value.trim(),
        // å­—æ•°æ§åˆ¶å‚æ•°
        positioning_length: parseInt(document.getElementById('positioning_length').value) || 100,
        objectives_length: parseInt(document.getElementById('objectives_length').value) || 80,
        module_content_length: parseInt(document.getElementById('module_content_length').value) || 60
      };
      
      // è°ƒç”¨ç”ŸæˆAPI
      const response = await fetch('{{ url_for("main.generate_teaching_outline_api") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'ç”Ÿæˆå¤±è´¥');
      }
      
      generatedData = await response.json();
      
      // å®Œæˆè¿›åº¦
      clearInterval(progressInterval);
      progressBar.style.width = '100%';
      progressText.textContent = 'âœ… ç”Ÿæˆå®Œæˆï¼';
      
      // æ˜¾ç¤ºç»“æœ
      setTimeout(() => {
        progressDiv.style.display = 'none';
        resultDiv.style.display = 'block';
        
        // è®¾ç½®ç”Ÿæˆçš„æ•°æ®åˆ°é¢„è§ˆåŒº
        generatedDataTextarea.value = JSON.stringify(generatedData, null, 2);
      }, 1000);
      
    } catch (error) {
      clearInterval(progressInterval);
      progressDiv.style.display = 'none';
      form.style.display = 'block';
      alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
    }
  });
  
  // ç”ŸæˆWordæ–‡æ¡£æŒ‰é’®
  document.getElementById('generate-word-btn').addEventListener('click', async () => {
    const wordBtn = document.getElementById('generate-word-btn');
    
    if (!generatedData || !generatedData['è¯¾ç¨‹åç§°']) {
      alert('è¯·å…ˆç”Ÿæˆæ•™å­¦å¤§çº²å†…å®¹');
      return;
    }
    
    wordBtn.disabled = true;
    wordBtn.textContent = 'ğŸ”„ æ­£åœ¨ç”ŸæˆWordæ–‡æ¡£...';
    
    try {
      const response = await fetch('{{ url_for("main.generate_word_document") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(generatedData)
      });
      
      if (response.ok) {
        const result = await response.json();
        if (result.success) {
          // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
          alert(`Wordæ–‡æ¡£ç”ŸæˆæˆåŠŸï¼š${result.filename}`);
          
          // è‡ªåŠ¨ä¸‹è½½
          const link = document.createElement('a');
          link.href = result.download_url;
          link.download = result.filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          wordBtn.textContent = 'âœ“ Wordæ–‡æ¡£å·²ç”Ÿæˆ';
        } else {
          throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥');
        }
      } else {
        const errorData = await response.json();
        throw new Error(errorData.error || 'ç”Ÿæˆå¤±è´¥');
      }
    } catch (error) {
      alert('Wordæ–‡æ¡£ç”Ÿæˆå¤±è´¥: ' + error.message);
      wordBtn.textContent = 'ğŸ“„ ç”ŸæˆWordæ–‡æ¡£';
    } finally {
      wordBtn.disabled = false;
    }
  });
  document.getElementById('preview-btn').addEventListener('click', async () => {
    try {
      const response = await fetch('{{ url_for("main.preview_teaching_outline") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(generatedData)
      });
      
      if (response.ok) {
        // è·³è½¬åˆ°é¢„è§ˆé¡µé¢
        window.location.href = response.url;
      } else {
        throw new Error('é¢„è§ˆå¤±è´¥');
      }
    } catch (error) {
      alert('é¢„è§ˆå¤±è´¥: ' + error.message);
    }
  });
  
  // ç¼–è¾‘æŒ‰é’®
  document.getElementById('edit-btn').addEventListener('click', () => {
    if (dataPreview.style.display === 'none') {
      dataPreview.style.display = 'block';
      document.getElementById('edit-btn').textContent = 'ğŸ™ˆ éšè—ç¼–è¾‘';
    } else {
      dataPreview.style.display = 'none';
      document.getElementById('edit-btn').textContent = 'âœï¸ ç¼–è¾‘å†…å®¹';
      
      // æ›´æ–°ç”Ÿæˆçš„æ•°æ®
      try {
        generatedData = JSON.parse(generatedDataTextarea.value);
      } catch (error) {
        alert('JSONæ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç¼–è¾‘å†…å®¹');
        dataPreview.style.display = 'block';
      }
    }
  });
  
  // é‡æ–°ç”ŸæˆæŒ‰é’®
  document.getElementById('regenerate-btn').addEventListener('click', () => {
    resultDiv.style.display = 'none';
    form.style.display = 'block';
    generatedData = {};
  });
  
})();
</script>
{% endblock %}