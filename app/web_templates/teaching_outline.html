{% extends 'layout.html' %}
{% block content %}
<div class="card">
  <h2>📚 教学大纲自动生成</h2>
  <p class="tip">填写基本信息，AI将自动生成完整的教学大纲内容。支持自定义重点模块和排除项。</p>
  
  <!-- 基本信息表单 -->
  <form id="outline-form">
    <div class="field">
      <label>课程名称 <span style="color:red;">*</span></label>
      <input type="text" id="course_name" placeholder="例如：计算机网络基础" required />
    </div>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
      <div class="field">
        <label>编写日期</label>
        <input type="text" id="write_date" placeholder="例如：2024年3月" />
        <div class="tip">留空将自动使用当前年月</div>
      </div>
      
      <div class="field">
        <label>考核方式及成绩评定办法</label>
        <input type="text" id="assessment_method" placeholder="例如：平时30% + 期中30% + 期末40%" />
      </div>
    </div>
    
    <!-- AI生成设置 -->
    <div class="field">
      <label>🤖 AI生成设置</label>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-top:8px;">
        <div>
          <span style="font-size:12px; color:#666; display:block; margin-bottom:4px;">大模型：</span>
          <select id="llm_provider" style="width:100%;">
            <option value="">离线模式（使用默认模板）</option>
            <option value="deepseek">DeepSeek</option>
            <option value="openai">OpenAI (ChatGPT)</option>
          </select>
        </div>
        <div>
          <span style="font-size:12px; color:#666; display:block; margin-bottom:4px;">API Key：</span>
          <input type="password" id="llm_api_key" placeholder="选择模型时必填" style="width:100%;" />
        </div>
        <div>
          <span style="font-size:12px; color:#666; display:block; margin-bottom:4px;">模型名称：</span>
          <input type="text" id="llm_model" placeholder="可选，留空使用默认" style="width:100%;" />
        </div>
      </div>
    </div>
    
    <!-- AI生成精细控制设置 -->
    <div class="field" style="margin-top:20px; padding:20px; background:#f8f9fa; border-radius:8px; border-left:4px solid #4CAF50;">
      <label style="font-size:16px; margin-bottom:15px; display:flex; align-items:center;">
        <span>🎛️ AI生成精细控制</span>
        <span style="font-size:12px; color:#666; margin-left:10px; font-weight:normal;">（设置AI生成的基调、规则和侧重点）</span>
      </label>
      
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:15px;">
        <div class="field" style="margin-bottom:0;">
          <label style="font-size:14px; color:#e74c3c; margin-bottom:8px;">🚫 排除项（不能出现的内容）</label>
          <textarea id="exclude_items" rows="4" placeholder="例如：人工智能、区块链、量子计算...&#10;明确指定不希望在教学大纲中出现的技术或内容"></textarea>
          <div class="tip">AI将严格避免生成这些内容</div>
        </div>
        
        <div class="field" style="margin-bottom:0;">
          <label style="font-size:14px; color:#f39c12; margin-bottom:8px;">💡 用户提示词（特别突出方向）</label>
          <textarea id="user_prompt" rows="4" placeholder="例如：突出工程实践能力、强化团队协作、注重创新思维培养、对接行业标准...&#10;在遵循基调和规则的基础上，特别强调和突出的方面"></textarea>
          <div class="tip">在系统基调基础上，进一步明确希望特别强调和突出的教学重点</div>
        </div>
      </div>
      
      <div class="field" style="margin-bottom:0;">
        <label style="font-size:14px; color:#9b59b6; margin-bottom:8px;">⚙️ 系统提示词（重点功能模块）</label>
        <textarea id="system_prompt" rows="4" placeholder="例如：注重实践性、符合企业需求、突出职业技能培养、遵循OBE教学理念、重点模块：数据库设计、网络编程、系统架构...&#10;设定AI生成内容的整体基调、教学理念、基本规则和重点关注的功能模块"></textarea>
        <div class="tip">定义AI生成内容应该遵循的教学理念、风格、基本要求和重点功能模块</div>
      </div>
    </div>
    
    <!-- 新增：字数控制设置 -->
    <div class="field" style="margin-top:15px; padding:15px; background:#f8f9fa; border-radius:6px;">
      <label>📏 内容长度控制</label>
      <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-top:8px;">
        <div>
          <span style="font-size:12px; color:#666;">课程定位字数:</span>
          <input type="number" id="positioning_length" value="100" min="50" max="300" style="width:100%; padding:6px; margin-top:4px;" />
        </div>
        <div>
          <span style="font-size:12px; color:#666;">教学目标字数:</span>
          <input type="number" id="objectives_length" value="80" min="30" max="200" style="width:100%; padding:6px; margin-top:4px;" />
        </div>
        <div>
          <span style="font-size:12px; color:#666;">模块内容字数:</span>
          <input type="number" id="module_content_length" value="60" min="30" max="150" style="width:100%; padding:6px; margin-top:4px;" />
        </div>
      </div>
      <div class="tip" style="margin-top:8px;">控制AI生成每个部分的内容长度，确保格式整齐统一</div>
    </div>
    
    <div style="text-align:center; margin-top:20px;">
      <button type="submit" class="btn" style="padding:12px 30px; font-size:16px;">
        🚀 自动生成教学大纲
      </button>
    </div>
  </form>
  
  <!-- 生成进度 -->
  <div id="progress" style="display:none; text-align:center; margin-top:20px;">
    <div style="font-size:16px; color:#666; margin-bottom:10px;">
      <span id="progress-text">🤖 AI正在生成教学大纲内容...</span>
    </div>
    <div style="width:100%; background:#f0f0f0; border-radius:10px; overflow:hidden;">
      <div id="progress-bar" style="width:0%; height:6px; background:linear-gradient(90deg, #4CAF50, #45a049); transition:width 0.3s;"></div>
    </div>
  </div>
  
  <!-- 生成结果 -->
  <div id="result" style="display:none; margin-top:30px;">
    <h3>✅ 生成完成</h3>
    <div style="text-align:center; margin:20px 0;">
      <button id="preview-btn" class="btn" style="margin-right:10px;">📋 预览大纲</button>
      <button id="generate-word-btn" class="btn" style="margin-right:10px; background:#28a745;">📄 生成Word文档</button>
      <button id="edit-btn" class="btn" style="margin-right:10px;">✏️ 编辑内容</button>
      <button id="regenerate-btn" class="btn" style="background:#ff9800;">🔄 重新生成</button>
    </div>
    
    <!-- 生成的数据预览 -->
    <div id="data-preview" style="display:none;">
      <h4>📊 生成的数据内容</h4>
      <textarea id="generated-data" readonly style="width:100%; height:300px; font-family:monospace; font-size:12px;"></textarea>
    </div>
  </div>
</div>

<style>
.field {
  margin-bottom: 15px;
}

.field label {
  display: block;
  font-weight: bold;
  margin-bottom: 5px;
  color: #333;
}

.field input, .field select, .field textarea {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  box-sizing: border-box;
}

.field input:focus, .field select:focus, .field textarea:focus {
  outline: none;
  border-color: #4CAF50;
  box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
}

.tip {
  font-size: 12px;
  color: #666;
  margin-top: 4px;
}

.btn {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.3s;
}

.btn:hover {
  background: #45a049;
}

.btn:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.card {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  max-width: 1000px;
  margin: 0 auto;
}
</style>

<script>
(function() {
  const form = document.getElementById('outline-form');
  const progressDiv = document.getElementById('progress');
  const progressText = document.getElementById('progress-text');
  const progressBar = document.getElementById('progress-bar');
  const resultDiv = document.getElementById('result');
  const dataPreview = document.getElementById('data-preview');
  const generatedDataTextarea = document.getElementById('generated-data');
  
  let generatedData = {};
  
  // 设置当前日期为默认值
  const now = new Date();
  const defaultDate = `${now.getFullYear()}年${(now.getMonth() + 1).toString().padStart(2, '0')}月`;
  document.getElementById('write_date').value = defaultDate;
  
  // 表单提交处理
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const courseName = document.getElementById('course_name').value.trim();
    if (!courseName) {
      alert('请输入课程名称');
      return;
    }
    
    // 显示进度
    progressDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    form.style.display = 'none';
    
    // 模拟进度更新
    let progress = 0;
    const progressInterval = setInterval(() => {
      progress += Math.random() * 15;
      if (progress > 90) progress = 90;
      progressBar.style.width = progress + '%';
      
      if (progress < 30) {
        progressText.textContent = '🤖 AI正在分析课程内容...';
      } else if (progress < 60) {
        progressText.textContent = '📚 正在生成教学目标和内容...';
      } else {
        progressText.textContent = '⚙️ 正在完善教学安排...';
      }
    }, 500);
    
    try {
      // 准备数据
      const payload = {
        course_name: courseName,
        write_date: document.getElementById('write_date').value.trim(),
        assessment_method: document.getElementById('assessment_method').value.trim(),
        exclude_items: document.getElementById('exclude_items').value.trim(),
        // AI精细控制参数
        system_prompt: document.getElementById('system_prompt').value.trim(),
        user_prompt: document.getElementById('user_prompt').value.trim(),
        llm_provider: document.getElementById('llm_provider').value.trim(),
        llm_api_key: document.getElementById('llm_api_key').value.trim(),
        llm_model: document.getElementById('llm_model').value.trim(),
        // 字数控制参数
        positioning_length: parseInt(document.getElementById('positioning_length').value) || 100,
        objectives_length: parseInt(document.getElementById('objectives_length').value) || 80,
        module_content_length: parseInt(document.getElementById('module_content_length').value) || 60
      };
      
      // 调用生成API
      const response = await fetch('{{ url_for("main.generate_teaching_outline_api") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || '生成失败');
      }
      
      generatedData = await response.json();
      
      // 完成进度
      clearInterval(progressInterval);
      progressBar.style.width = '100%';
      progressText.textContent = '✅ 生成完成！';
      
      // 显示结果
      setTimeout(() => {
        progressDiv.style.display = 'none';
        resultDiv.style.display = 'block';
        
        // 设置生成的数据到预览区
        generatedDataTextarea.value = JSON.stringify(generatedData, null, 2);
      }, 1000);
      
    } catch (error) {
      clearInterval(progressInterval);
      progressDiv.style.display = 'none';
      form.style.display = 'block';
      alert('生成失败: ' + error.message);
    }
  });
  
  // 生成Word文档按钮
  document.getElementById('generate-word-btn').addEventListener('click', async () => {
    const wordBtn = document.getElementById('generate-word-btn');
    
    if (!generatedData || !generatedData['课程名称']) {
      alert('请先生成教学大纲内容');
      return;
    }
    
    wordBtn.disabled = true;
    wordBtn.textContent = '🔄 正在生成Word文档...';
    
    try {
      const response = await fetch('{{ url_for("main.generate_word_document") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(generatedData)
      });
      
      if (response.ok) {
        const result = await response.json();
        if (result.success) {
          // 显示成功消息
          alert(`Word文档生成成功：${result.filename}`);
          
          // 自动下载
          const link = document.createElement('a');
          link.href = result.download_url;
          link.download = result.filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          wordBtn.textContent = '✓ Word文档已生成';
        } else {
          throw new Error(result.error || '生成失败');
        }
      } else {
        const errorData = await response.json();
        throw new Error(errorData.error || '生成失败');
      }
    } catch (error) {
      alert('Word文档生成失败: ' + error.message);
      wordBtn.textContent = '📄 生成Word文档';
    } finally {
      wordBtn.disabled = false;
    }
  });
  document.getElementById('preview-btn').addEventListener('click', async () => {
    try {
      const response = await fetch('{{ url_for("main.preview_teaching_outline") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(generatedData)
      });
      
      if (response.ok) {
        // 跳转到预览页面
        window.location.href = response.url;
      } else {
        throw new Error('预览失败');
      }
    } catch (error) {
      alert('预览失败: ' + error.message);
    }
  });
  
  // 编辑按钮
  document.getElementById('edit-btn').addEventListener('click', () => {
    if (dataPreview.style.display === 'none') {
      dataPreview.style.display = 'block';
      document.getElementById('edit-btn').textContent = '🙈 隐藏编辑';
    } else {
      dataPreview.style.display = 'none';
      document.getElementById('edit-btn').textContent = '✏️ 编辑内容';
      
      // 更新生成的数据
      try {
        generatedData = JSON.parse(generatedDataTextarea.value);
      } catch (error) {
        alert('JSON格式错误，请检查编辑内容');
        dataPreview.style.display = 'block';
      }
    }
  });
  
  // 重新生成按钮
  document.getElementById('regenerate-btn').addEventListener('click', () => {
    resultDiv.style.display = 'none';
    form.style.display = 'block';
    generatedData = {};
  });
  
})();
</script>
{% endblock %}