#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ•™å­¦å¤§çº²ç”Ÿæˆå™¨
ä½¿ç”¨AIè‡ªåŠ¨ç”Ÿæˆæ•™å­¦å¤§çº²çš„å„ä¸ªéƒ¨åˆ†
"""

import json
import requests
from datetime import datetime
from loguru import logger


def generate_teaching_outline(course_name, write_date=None, assessment_method=None, 
                            exclude_items=None, system_prompt=None, user_prompt=None,
                            llm_provider=None, llm_api_key=None, llm_model=None,
                            positioning_length=100, objectives_length=80, module_content_length=60):
    """
    ç”Ÿæˆå®Œæ•´çš„æ•™å­¦å¤§çº²å†…å®¹
    
    Args:
        course_name: è¯¾ç¨‹åç§°
        write_date: ç¼–å†™æ—¥æœŸ
        assessment_method: è€ƒæ ¸æ–¹å¼åŠæˆç»©è¯„å®šåŠæ³•
        focus_modules: é‡ç‚¹åŠŸèƒ½æ¨¡å—
        exclude_items: æ’é™¤é¡¹
        llm_provider: å¤§æ¨¡å‹æä¾›å•†
        llm_api_key: APIå¯†é’¥
        llm_model: æ¨¡å‹åç§°
    
    Returns:
        dict: åŒ…å«æ‰€æœ‰æ¨¡æ¿å˜é‡çš„å­—å…¸
    """
    
    # è®¾ç½®é»˜è®¤å€¼
    if not write_date:
        write_date = datetime.now().strftime("%Yå¹´%mæœˆ")
    
    if not assessment_method:
        assessment_method = "å¹³æ—¶æˆç»©30% + æœŸä¸­è€ƒè¯•30% + æœŸæœ«è€ƒè¯•40%"
    
    # æ„å»ºåŸºç¡€æ•°æ®
    outline_data = {
        'è¯¾ç¨‹åç§°': course_name,
        'ç¼–å†™æ—¥æœŸ': write_date,
        'è€ƒæ ¸æ–¹å¼åŠæˆç»©è¯„å®šåŠæ³•': assessment_method,
    }
    
    # å¦‚æœæœ‰AIé…ç½®ï¼Œä½¿ç”¨AIç”Ÿæˆå†…å®¹
    if llm_provider and llm_api_key:
        try:
            ai_generated = generate_with_ai(
                course_name, exclude_items,
                system_prompt, user_prompt,
                llm_provider, llm_api_key, llm_model,
                positioning_length, objectives_length, module_content_length
            )
            outline_data.update(ai_generated)
        except Exception as e:
            logger.error(f"AIç”Ÿæˆå¤±è´¥: {e}")
            # å¦‚æœAIç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ¨¡æ¿
            outline_data.update(generate_default_content(course_name))
    else:
        # ä½¿ç”¨é»˜è®¤æ¨¡æ¿ç”Ÿæˆ
        outline_data.update(generate_default_content(course_name))
    
    return outline_data


def generate_with_ai(course_name, exclude_items,
                    system_prompt, user_prompt, 
                    llm_provider, llm_api_key, llm_model,
                    positioning_length=100, objectives_length=80, module_content_length=60):
    """
    ä½¿ç”¨AIç”Ÿæˆæ•™å­¦å¤§çº²å†…å®¹
    """
    
    # æ„å»ºæç¤ºè¯
    prompt = build_prompt(course_name, exclude_items, 
                         system_prompt, user_prompt,
                         positioning_length, objectives_length, module_content_length)
    
    # æ ¹æ®ä¸åŒçš„æ¨¡å‹æä¾›å•†è°ƒç”¨API
    if llm_provider.lower() == 'deepseek':
        response = call_deepseek_api(prompt, llm_api_key, llm_model or 'deepseek-chat')
    elif llm_provider.lower() == 'openai':
        response = call_openai_api(prompt, llm_api_key, llm_model or 'gpt-4o-mini')
    else:
        raise ValueError(f"ä¸æ”¯æŒçš„æ¨¡å‹æä¾›å•†: {llm_provider}")
    
    # è§£æAIå“åº”
    return parse_ai_response(response)


def build_prompt(course_name, exclude_items=None,
                system_prompt=None, user_prompt=None, 
                positioning_length=100, objectives_length=80, module_content_length=60):
    """
    æ„å»ºAIç”Ÿæˆçš„æç¤ºè¯
    """
    
    # è§£æé‡ç‚¹æ¨¡å—ï¼Œç¡®ä¿AIçœŸæ­£å…³æ³¨ç”¨æˆ·è¾“å…¥
    focus_requirements = ""
    if focus_modules and focus_modules.strip():
        focus_list = [m.strip() for m in focus_modules.replace('ï¼Œ', ',').split(',') if m.strip()]
        if focus_list:
            focus_requirements = f"""
ã€â—ï¸æœ€é«˜ä¼˜å…ˆçº§ã€‘é‡ç‚¹åŠŸèƒ½æ¨¡å—å¼ºåˆ¶è¦æ±‚ï¼š
ç”¨æˆ·æ˜ç¡®æŒ‡å®šäº†ä»¥ä¸‹é‡ç‚¹æ¨¡å—ï¼š{', '.join(focus_list)}

ğŸ”¥ä¸¥æ ¼å¼ºåˆ¶è¦æ±‚ï¼š
1. åœ¨8ä¸ªæ•™å­¦æ¨¡å—ä¸­ï¼Œå¿…é¡»è‡³å°‘æœ‰{min(len(focus_list), 6)}ä¸ªæ¨¡å—ç›´æ¥ä½“ç°è¿™äº›é‡ç‚¹å†…å®¹
2. æ•™å­¦æ¨¡å—åç§°å¿…é¡»åŒ…å«é‡ç‚¹æ¨¡å—çš„å…³é”®è¯ï¼Œä¸èƒ½æ˜¯â€œåŸºç¡€ç†è®ºâ€ç­‰é€šç”¨è¯
3. æ•™å­¦å†…å®¹å¿…é¡»ç´§å¯†å›´ç»•é‡ç‚¹æ¨¡å—è®¾è®¡ï¼Œä¸èƒ½ä½¿ç”¨æ¨¡ç³Šæè¿°
4. ç¦æ­¢ä½¿ç”¨é€šç”¨æ¨¡æ¿ï¼Œå¿…é¡»é’ˆå¯¹å…·ä½“è¯¾ç¨‹å’Œé‡ç‚¹æ¨¡å—å®šåˆ¶åŒ–ç”Ÿæˆ

ğŸŒ†å…·ä½“ç¤ºä¾‹ï¼šå¦‚æœé‡ç‚¹æ¨¡å—æ˜¯â€œæ•°æ®åº“è®¾è®¡â€ï¼Œåˆ™ï¼š
- æ•™å­¦æ¨¡å—åç§°åº”ä¸ºâ€œæ•°æ®åº“è®¾è®¡ä¸å®ç°â€æˆ–â€œå…³ç³»æ•°æ®åº“è®¾è®¡â€
- æ•™å­¦å†…å®¹å¿…é¡»åŒ…å«ï¼šERå›¾è®¾è®¡ã€è¡¨ç»“æ„è®¾è®¡ã€ç´¢å¼•ä¼˜åŒ–ç­‰å…·ä½“æŠ€æœ¯
- é‡ç‚¹å’Œéš¾ç‚¹ï¼šæ•°æ®åº“èŒƒå¼åŒ–ã€æŸ¥è¯¢ä¼˜åŒ–ã€æ•°æ®ä¸€è‡´æ€§ç­‰å…·ä½“éš¾ç‚¹
"""
    
    exclude_requirements = ""
    if exclude_items and exclude_items.strip():
        exclude_requirements = f"""
ğŸš«æ’é™¤å†…å®¹ï¼š{exclude_items}
ï¼ˆåœ¨æ‰€æœ‰å†…å®¹ä¸­ä¸¥æ ¼é¿å…æˆ–å‡å°‘è¿™äº›å†…å®¹ï¼‰
"""
    
    # å¤„ç†ç³»ç»Ÿæç¤ºè¯ï¼ˆåŸºè°ƒã€è§„åˆ™å’Œé‡ç‚¹æ¨¡å—ï¼‰
    system_requirements = ""
    if system_prompt and system_prompt.strip():
        # ä»ç³»ç»Ÿæç¤ºè¯ä¸­æå–é‡ç‚¹æ¨¡å—
        focus_modules_from_system = ""
        import re
        # æŸ¥æ‰¾é‡ç‚¹æ¨¡å—ç›¸å…³å…³é”®è¯
        if 'é‡ç‚¹' in system_prompt or 'æ¨¡å—' in system_prompt:
            # æå–é‡ç‚¹æ¨¡å—ä¿¡æ¯
            focus_match = re.search(r'é‡ç‚¹[^\n]*[:]ï¼ˆ\])*([^\n]+)', system_prompt)
            if focus_match:
                focus_content = focus_match.group(1).strip()
                focus_list = [m.strip() for m in focus_content.replace('ï¼Œ', ',').split(',') if m.strip()]
                if focus_list:
                    focus_modules_from_system = f"""

ã€â—ï¸æœ€é«˜ä¼˜å…ˆçº§ã€‘é‡ç‚¹åŠŸèƒ½æ¨¡å—å¼ºåˆ¶è¦æ±‚ï¼š
ç”¨æˆ·åœ¨ç³»ç»Ÿæç¤ºè¯ä¸­æ˜ç¡®æŒ‡å®šäº†ä»¥ä¸‹é‡ç‚¹æ¨¡å—ï¼š{', '.join(focus_list)}

ğŸ”¥ä¸¥æ ¼å¼ºåˆ¶è¦æ±‚ï¼š
1. åœ¨8ä¸ªæ•™å­¦æ¨¡å—ä¸­ï¼Œå¿…é¡»è‡³å°‘æœ‰{min(len(focus_list), 6)}ä¸ªæ¨¡å—ç›´æ¥ä½“ç°è¿™äº›é‡ç‚¹å†…å®¹
2. æ•™å­¦æ¨¡å—åç§°å¿…é¡»åŒ…å«é‡ç‚¹æ¨¡å—çš„å…³é”®è¯ï¼Œä¸èƒ½æ˜¯â€œåŸºç¡€ç†è®ºâ€ç­‰é€šç”¨è¯
3. æ•™å­¦å†…å®¹å¿…é¡»ç´§å¯†å›´ç»•é‡ç‚¹æ¨¡å—è®¾è®¡ï¼Œä¸èƒ½ä½¿ç”¨æ¨¡ç³Šæè¿°
4. ç¦æ­¢ä½¿ç”¨é€šç”¨æ¨¡æ¿ï¼Œå¿…é¡»é’ˆå¯¹å…·ä½“è¯¾ç¨‹å’Œé‡ç‚¹æ¨¡å—å®šåˆ¶åŒ–ç”Ÿæˆ
"""
        
        system_requirements = f"""
âš™ï¸ ç³»ç»ŸåŸºè°ƒå’Œè§„åˆ™ï¼š
{system_prompt}
{focus_modules_from_system}

ã€å¼ºåˆ¶è¦æ±‚ã€‘åœ¨ç”Ÿæˆæ‰€æœ‰å†…å®¹æ—¶ï¼Œå¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸Šç³»ç»ŸåŸºè°ƒå’Œè§„åˆ™ã€‚
"""
    
    # å¤„ç†ç”¨æˆ·æç¤ºè¯ï¼ˆé‡ç‚¹çªå‡ºæ–¹å‘ï¼‰
    user_requirements = ""
    if user_prompt and user_prompt.strip():
        user_requirements = f"""
ğŸ’¡ ç‰¹åˆ«å¼ºè°ƒå’Œçªå‡ºæ–¹å‘ï¼š
{user_prompt}

åœ¨éµå¾ªç³»ç»ŸåŸºè°ƒçš„å‰æä¸‹ï¼Œè¯·ç‰¹åˆ«å¼ºè°ƒå’Œçªå‡ºä»¥ä¸Šæ–¹é¢ã€‚
"""
    
    prompt = f"""
ä½ æ˜¯ä¸€ä½èµ„æ·±çš„è¯¾ç¨‹è®¾è®¡ä¸“å®¶ï¼Œè¯·ä¸ºã€Š{course_name}ã€‹è¯¾ç¨‹ç”Ÿæˆé«˜è´¨é‡ã€ä¸ªæ€§åŒ–çš„æ•™å­¦å¤§çº²å†…å®¹ã€‚

{system_requirements}

ğŸ¯ è¯¾ç¨‹ç‰¹è‰²åŒ–å¼ºåˆ¶è¦æ±‚ï¼š
æ ¹æ®è¯¾ç¨‹åç§°ã€Š{course_name}ã€‹ï¼Œæ‰€æœ‰ç”Ÿæˆå†…å®¹å¿…é¡»ä¸è¯¥è¯¾ç¨‹é«˜åº¦ç›¸å…³ï¼š
- æ•™å­¦æ¨¡å—åç§°å¿…é¡»åŒ…å«{course_name}çš„å…³é”®æŠ€æœ¯è¯æ±‡ï¼Œç¦æ­¢ä½¿ç”¨â€œåŸºç¡€ç†è®ºâ€ç­‰é€šç”¨è¯
- æ•™å­¦å†…å®¹å¿…é¡»ä½“ç°{course_name}çš„å…·ä½“æŠ€æœ¯ç‚¹å’Œåº”ç”¨åœºæ™¯
- æ¯ä¸ªæ¨¡å—çš„é‡ç‚¹éš¾ç‚¹å¿…é¡»é’ˆå¯¹{course_name}çš„å…·ä½“æŠ€æœ¯éš¾ç‚¹

{exclude_requirements}

{user_requirements}

å†…å®¹é•¿åº¦æ§åˆ¶è¦æ±‚ï¼š
- è¯¾ç¨‹å®šä½ï¼šçº¦{positioning_length}å­—
- çŸ¥è¯†ç›®æ ‡ã€æŠ€èƒ½ç›®æ ‡ã€ç´ è´¨ç›®æ ‡ï¼šæ¯é¡¹çº¦{objectives_length}å­—
- æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹ï¼šæ¯é¡¹çº¦{module_content_length}å­—
- å…¶ä»–å­—æ®µï¼šæ ¹æ®å®é™…éœ€è¦é€‚å½“æ§åˆ¶é•¿åº¦

ç”Ÿæˆè¦æ±‚ï¼š
1. å†…å®¹å¿…é¡»ä¸“ä¸šã€å‡†ç¡®ï¼Œç¬¦åˆé«˜ç­‰æ•™è‚²æ•™å­¦å¤§çº²è§„èŒƒ
2. æ•™å­¦æ¨¡å—è¦ä½“ç°è¯¾ç¨‹ç‰¹è‰²ï¼Œä¸èƒ½ä½¿ç”¨é€šç”¨æ¨¡æ¿
3. å¿…é¡»æ ¹æ®è¯¾ç¨‹åç§°å®šåˆ¶åŒ–ç”Ÿæˆç›¸å…³å†…å®¹
4. 8ä¸ªæ•™å­¦æ¨¡å—åº”å¾ªåºæ¸è¿›ï¼Œè¯¾æ—¶å®‰æ’åˆç†ï¼ˆæ€»è®¡64-72å­¦æ—¶ï¼‰
5. ä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼è¿”å›ï¼Œç¡®ä¿å­—æ®µå®Œæ•´

è¯·è¿”å›ä»¥ä¸‹å®Œæ•´çš„JSONæ ¼å¼ï¼š
{{
    "è¯¾ç¨‹å®šä½": "çº¦{positioning_length}å­—ï¼Œæè¿°è¯¾ç¨‹åœ¨ä¸“ä¸šåŸ¹å…»ä¸­çš„åœ°ä½å’Œä½œç”¨",
    "çŸ¥è¯†ç›®æ ‡": "çº¦{objectives_length}å­—ï¼Œå­¦ç”Ÿåº”æŒæ¡çš„ç†è®ºçŸ¥è¯†å’Œæ¦‚å¿µ",
    "æŠ€èƒ½ç›®æ ‡": "çº¦{objectives_length}å­—ï¼Œå­¦ç”Ÿåº”å…·å¤‡çš„å®è·µæŠ€èƒ½å’Œæ“ä½œèƒ½åŠ›",
    "ç´ è´¨ç›®æ ‡": "çº¦{objectives_length}å­—ï¼Œå­¦ç”Ÿåº”åŸ¹å…»çš„èŒä¸šç´ å…»å’Œç»¼åˆèƒ½åŠ›",
    "æ•™å­¦æ–¹å¼ã€æ–¹æ³•ä¸æ‰‹æ®µå»ºè®®": "å…·ä½“çš„æ•™å­¦æ–¹æ³•å’Œæ‰‹æ®µ",
    "æ•™å­¦åŠå‚è€ƒèµ„æ–™": "æ¨èçš„æ•™æå’Œå‚è€ƒä¹¦ç›®",
    "è¯¾ç¨‹ç¼–ç ": "è¯¾ç¨‹ä»£ç ",
    "å­¦æ—¶": "æ€»å­¦æ—¶æ•°",
    "å­¦åˆ†": "å­¦åˆ†æ•°",
    "è¯¾ç¨‹ç±»åˆ«": "è¯¾ç¨‹ç±»å‹",
    "é€‚ç”¨ä¸“ä¸š": "é€‚ç”¨çš„ä¸“ä¸šåç§°",
    "modules": [
        {{
            "æ¨¡å—ç¼–å·": 1,
            "æ•™å­¦æ¨¡å—": "å¿…é¡»åŒ…å«ã€Š{course_name}ã€‹çš„å…³é”®è¯ï¼Œä¸èƒ½æ˜¯é€šç”¨åç§°",
            "æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹": "çº¦{module_content_length}å­—ï¼Œå¿…é¡»æ˜¯ã€Š{course_name}ã€‹çš„å…·ä½“æŠ€æœ¯å†…å®¹ï¼Œä¸èƒ½æ˜¯æ¨¡ç³Šæè¿°",
            "èŒä¸šæŠ€èƒ½è¦æ±‚": "é’ˆå¯¹ã€Š{course_name}ã€‹çš„å…·ä½“æŠ€èƒ½è¦æ±‚",
            "è¯¾æ—¶": "è¯¾æ—¶å®‰æ’",
            "æ•™å­¦æ–¹æ³•å»ºè®®": "é’ˆå¯¹æ€§æ•™å­¦æ–¹æ³•"
        }},
        {{
            "æ¨¡å—ç¼–å·": 2,
            "æ•™å­¦æ¨¡å—": "ç¬¬äºŒä¸ªæ•™å­¦æ¨¡å—åç§°",
            "æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹": "çº¦{module_content_length}å­—ï¼Œè¯¦ç»†å†…å®¹ã€é‡ç‚¹å’Œéš¾ç‚¹",
            "èŒä¸šæŠ€èƒ½è¦æ±‚": "æŠ€èƒ½è¦æ±‚",
            "è¯¾æ—¶": "è¯¾æ—¶å®‰æ’",
            "æ•™å­¦æ–¹æ³•å»ºè®®": "æ•™å­¦æ–¹æ³•"
        }},
        {{
            "æ¨¡å—ç¼–å·": 3,
            "æ•™å­¦æ¨¡å—": "ç¬¬ä¸‰ä¸ªæ•™å­¦æ¨¡å—åç§°",
            "æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹": "çº¦{module_content_length}å­—ï¼Œè¯¦ç»†å†…å®¹ã€é‡ç‚¹å’Œéš¾ç‚¹",
            "èŒä¸šæŠ€èƒ½è¦æ±‚": "æŠ€èƒ½è¦æ±‚",
            "è¯¾æ—¶": "è¯¾æ—¶å®‰æ’",
            "æ•™å­¦æ–¹æ³•å»ºè®®": "æ•™å­¦æ–¹æ³•"
        }},
        {{
            "æ¨¡å—ç¼–å·": 4,
            "æ•™å­¦æ¨¡å—": "ç¬¬å››ä¸ªæ•™å­¦æ¨¡å—åç§°",
            "æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹": "çº¦{module_content_length}å­—ï¼Œè¯¦ç»†å†…å®¹ã€é‡ç‚¹å’Œéš¾ç‚¹",
            "èŒä¸šæŠ€èƒ½è¦æ±‚": "æŠ€èƒ½è¦æ±‚",
            "è¯¾æ—¶": "è¯¾æ—¶å®‰æ’",
            "æ•™å­¦æ–¹æ³•å»ºè®®": "æ•™å­¦æ–¹æ³•"
        }},
        {{
            "æ¨¡å—ç¼–å·": 5,
            "æ•™å­¦æ¨¡å—": "ç¬¬äº”ä¸ªæ•™å­¦æ¨¡å—åç§°",
            "æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹": "çº¦{module_content_length}å­—ï¼Œè¯¦ç»†å†…å®¹ã€é‡ç‚¹å’Œéš¾ç‚¹",
            "èŒä¸šæŠ€èƒ½è¦æ±‚": "æŠ€èƒ½è¦æ±‚",
            "è¯¾æ—¶": "è¯¾æ—¶å®‰æ’",
            "æ•™å­¦æ–¹æ³•å»ºè®®": "æ•™å­¦æ–¹æ³•"
        }},
        {{
            "æ¨¡å—ç¼–å·": 6,
            "æ•™å­¦æ¨¡å—": "ç¬¬å…­ä¸ªæ•™å­¦æ¨¡å—åç§°",
            "æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹": "çº¦{module_content_length}å­—ï¼Œè¯¦ç»†å†…å®¹ã€é‡ç‚¹å’Œéš¾ç‚¹",
            "èŒä¸šæŠ€èƒ½è¦æ±‚": "æŠ€èƒ½è¦æ±‚",
            "è¯¾æ—¶": "è¯¾æ—¶å®‰æ’",
            "æ•™å­¦æ–¹æ³•å»ºè®®": "æ•™å­¦æ–¹æ³•"
        }},
        {{
            "æ¨¡å—ç¼–å·": 7,
            "æ•™å­¦æ¨¡å—": "ç¬¬ä¸ƒä¸ªæ•™å­¦æ¨¡å—åç§°",
            "æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹": "çº¦{module_content_length}å­—ï¼Œè¯¦ç»†å†…å®¹ã€é‡ç‚¹å’Œéš¾ç‚¹",
            "èŒä¸šæŠ€èƒ½è¦æ±‚": "æŠ€èƒ½è¦æ±‚",
            "è¯¾æ—¶": "è¯¾æ—¶å®‰æ’",
            "æ•™å­¦æ–¹æ³•å»ºè®®": "æ•™å­¦æ–¹æ³•"
        }},
        {{
            "æ¨¡å—ç¼–å·": 8,
            "æ•™å­¦æ¨¡å—": "ç¬¬å…«ä¸ªæ•™å­¦æ¨¡å—åç§°",
            "æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹": "çº¦{module_content_length}å­—ï¼Œè¯¦ç»†å†…å®¹ã€é‡ç‚¹å’Œéš¾ç‚¹",
            "èŒä¸šæŠ€èƒ½è¦æ±‚": "æŠ€èƒ½è¦æ±‚",
            "è¯¾æ—¶": "è¯¾æ—¶å®‰æ’",
            "æ•™å­¦æ–¹æ³•å»ºè®®": "æ•™å­¦æ–¹æ³•"
        }}
    ],
    "æ€»è¯¾æ—¶": "æ‰€æœ‰æ¨¡å—çš„æ€»è¯¾æ—¶"
}}

ã€å…³é”®æé†’ã€‘ï¼š
1. å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°JSONæ ¼å¼è¿”å›å®Œæ•´å†…å®¹
2. modulesæ•°ç»„å¿…é¡»åŒ…å«8ä¸ªå®Œæ•´çš„æ¨¡å—å¯¹è±¡
3. å¦‚æœç”¨æˆ·æŒ‡å®šäº†é‡ç‚¹æ¨¡å—ï¼Œå¿…é¡»åœ¨ç›¸åº”çš„æ•™å­¦æ¨¡å—ä¸­ä½“ç°
4. å†…å®¹ä¸èƒ½æ˜¯é€šç”¨æ¨¡æ¿ï¼Œå¿…é¡»æ ¹æ®å…·ä½“è¯¾ç¨‹å®šåˆ¶åŒ–ç”Ÿæˆ
5. ç¡®ä¿å­—æ•°æ§åˆ¶åœ¨æŒ‡å®šèŒƒå›´å†…
"""

    return prompt


def call_deepseek_api(prompt, api_key, model):
    """
    è°ƒç”¨DeepSeek API
    """
    url = "https://api.deepseek.com/v1/chat/completions"
    
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {api_key}"
    }
    
    data = {
        "model": model,
        "messages": [
            {"role": "user", "content": prompt}
        ],
        "temperature": 0.9,
        "max_tokens": 4000
    }
    
    response = requests.post(url, headers=headers, json=data, timeout=60)
    response.raise_for_status()
    
    result = response.json()
    return result['choices'][0]['message']['content']


def call_openai_api(prompt, api_key, model):
    """
    è°ƒç”¨OpenAI API
    """
    url = "https://api.openai.com/v1/chat/completions"
    
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {api_key}"
    }
    
    data = {
        "model": model,
        "messages": [
            {"role": "user", "content": prompt}
        ],
        "temperature": 0.9,
        "max_tokens": 4000
    }
    
    response = requests.post(url, headers=headers, json=data, timeout=60)
    response.raise_for_status()
    
    result = response.json()
    return result['choices'][0]['message']['content']


def parse_ai_response(response_text):
    """
    è§£æAIè¿”å›çš„JSONå“åº”
    """
    try:
        # å°è¯•ç›´æ¥è§£æJSON
        data = json.loads(response_text)
        
        # å¤„ç†æ–°çš„modulesæ•°ç»„æ ¼å¼ï¼Œå°†å…¶å±•å¼€ä¸ºæ‰å¹³ç»“æ„
        if 'modules' in data and isinstance(data['modules'], list):
            modules_data = data.pop('modules')  # ç§»é™¤modulesæ•°ç»„
            
            # å°†modulesæ•°ç»„ä¸­çš„æ¯ä¸ªæ¨¡å—å±•å¼€ä¸ºåŸæ¥çš„æ‰å¹³å­—æ®µæ ¼å¼
            for module in modules_data:
                if isinstance(module, dict) and 'æ¨¡å—ç¼–å·' in module:
                    module_num = module['æ¨¡å—ç¼–å·']
                    
                    # å°†æ¨¡å—æ•°æ®æ˜ å°„åˆ°åŸæ¥çš„å­—æ®µå
                    if 'æ•™å­¦æ¨¡å—' in module:
                        data[f'æ•™å­¦æ¨¡å—{module_num}'] = module['æ•™å­¦æ¨¡å—']
                    if 'æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹' in module:
                        data[f'æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹{module_num}'] = module['æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹']
                    if 'èŒä¸šæŠ€èƒ½è¦æ±‚' in module:
                        data[f'èŒä¸šæŠ€èƒ½è¦æ±‚{module_num}'] = module['èŒä¸šæŠ€èƒ½è¦æ±‚']
                    if 'è¯¾æ—¶' in module:
                        data[f'è¯¾æ—¶{module_num}'] = module['è¯¾æ—¶']
                    if 'æ•™å­¦æ–¹æ³•å»ºè®®' in module:
                        data[f'æ•™å­¦æ–¹æ³•å»ºè®®{module_num}'] = module['æ•™å­¦æ–¹æ³•å»ºè®®']
        
        return data
        
    except json.JSONDecodeError:
        # å¦‚æœä¸æ˜¯çº¯JSONï¼Œå°è¯•æå–JSONéƒ¨åˆ†
        try:
            # æŸ¥æ‰¾JSONä»£ç å—
            import re
            json_match = re.search(r'```json\s*(.*?)\s*```', response_text, re.DOTALL)
            if json_match:
                json_str = json_match.group(1)
                data = json.loads(json_str)
                
                # å¤„ç†modulesæ•°ç»„æ ¼å¼
                if 'modules' in data and isinstance(data['modules'], list):
                    modules_data = data.pop('modules')
                    for module in modules_data:
                        if isinstance(module, dict) and 'æ¨¡å—ç¼–å·' in module:
                            module_num = module['æ¨¡å—ç¼–å·']
                            if 'æ•™å­¦æ¨¡å—' in module:
                                data[f'æ•™å­¦æ¨¡å—{module_num}'] = module['æ•™å­¦æ¨¡å—']
                            if 'æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹' in module:
                                data[f'æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹{module_num}'] = module['æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹']
                            if 'èŒä¸šæŠ€èƒ½è¦æ±‚' in module:
                                data[f'èŒä¸šæŠ€èƒ½è¦æ±‚{module_num}'] = module['èŒä¸šæŠ€èƒ½è¦æ±‚']
                            if 'è¯¾æ—¶' in module:
                                data[f'è¯¾æ—¶{module_num}'] = module['è¯¾æ—¶']
                            if 'æ•™å­¦æ–¹æ³•å»ºè®®' in module:
                                data[f'æ•™å­¦æ–¹æ³•å»ºè®®{module_num}'] = module['æ•™å­¦æ–¹æ³•å»ºè®®']
                
                return data
            
            # æŸ¥æ‰¾å¤§æ‹¬å·åŒ…å›´çš„JSON
            json_match = re.search(r'\{.*\}', response_text, re.DOTALL)
            if json_match:
                json_str = json_match.group()
                data = json.loads(json_str)
                
                # å¤„ç†modulesæ•°ç»„æ ¼å¼
                if 'modules' in data and isinstance(data['modules'], list):
                    modules_data = data.pop('modules')
                    for module in modules_data:
                        if isinstance(module, dict) and 'æ¨¡å—ç¼–å·' in module:
                            module_num = module['æ¨¡å—ç¼–å·']
                            if 'æ•™å­¦æ¨¡å—' in module:
                                data[f'æ•™å­¦æ¨¡å—{module_num}'] = module['æ•™å­¦æ¨¡å—']
                            if 'æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹' in module:
                                data[f'æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹{module_num}'] = module['æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹']
                            if 'èŒä¸šæŠ€èƒ½è¦æ±‚' in module:
                                data[f'èŒä¸šæŠ€èƒ½è¦æ±‚{module_num}'] = module['èŒä¸šæŠ€èƒ½è¦æ±‚']
                            if 'è¯¾æ—¶' in module:
                                data[f'è¯¾æ—¶{module_num}'] = module['è¯¾æ—¶']
                            if 'æ•™å­¦æ–¹æ³•å»ºè®®' in module:
                                data[f'æ•™å­¦æ–¹æ³•å»ºè®®{module_num}'] = module['æ•™å­¦æ–¹æ³•å»ºè®®']
                
                return data
                
        except json.JSONDecodeError:
            pass
    
    # å¦‚æœè§£æå¤±è´¥ï¼Œè¿”å›é»˜è®¤å†…å®¹
    logger.error(f"æ— æ³•è§£æAIå“åº”: {response_text}")
    return {}


def generate_default_content(course_name):
    """
    ç”Ÿæˆé»˜è®¤çš„æ•™å­¦å¤§çº²å†…å®¹æ¨¡æ¿
    """
    return {
        'è¯¾ç¨‹å®šä½': f'{course_name}æ˜¯ä¸“ä¸šæ ¸å¿ƒè¯¾ç¨‹ï¼Œæ—¨åœ¨åŸ¹å…»å­¦ç”Ÿçš„ä¸“ä¸šæŠ€èƒ½å’Œå®è·µèƒ½åŠ›ï¼Œåœ¨ä¸“ä¸šè¯¾ç¨‹ä½“ç³»ä¸­èµ·åˆ°æ‰¿ä¸Šå¯ä¸‹çš„é‡è¦ä½œç”¨ã€‚',
        'çŸ¥è¯†ç›®æ ‡': f'1. æŒæ¡{course_name}çš„åŸºæœ¬ç†è®ºã€æ ¸å¿ƒæ¦‚å¿µå’ŒåŸºç¡€çŸ¥è¯†\n2. ç†è§£ç›¸å…³æŠ€æœ¯åŸç†å’Œå‘å±•è¶‹åŠ¿\n3. ç†Ÿæ‚‰è¡Œä¸šæ ‡å‡†å’Œè§„èŒƒè¦æ±‚',
        'æŠ€èƒ½ç›®æ ‡': f'1. å…·å¤‡{course_name}ç›¸å…³çš„å®è·µæ“ä½œèƒ½åŠ›å’Œé—®é¢˜è§£å†³èƒ½åŠ›\n2. æŒæ¡ä¸“ä¸šå·¥å…·å’Œè½¯ä»¶çš„ä½¿ç”¨æ–¹æ³•\n3. èƒ½å¤Ÿç‹¬ç«‹å®Œæˆç›¸å…³é¡¹ç›®å’Œä»»åŠ¡',
        'ç´ è´¨ç›®æ ‡': '1. åŸ¹å…»è‰¯å¥½çš„èŒä¸šé“å¾·å’ŒèŒä¸šç´ å…»\n2. å¢å¼ºå›¢é˜Ÿåä½œç²¾ç¥å’Œæ²Ÿé€šèƒ½åŠ›\n3. åŸ¹å…»åˆ›æ–°æ„è¯†å’ŒæŒç»­å­¦ä¹ èƒ½åŠ›',
        'æ•™å­¦æ–¹å¼ã€æ–¹æ³•ä¸æ‰‹æ®µå»ºè®®': 'é‡‡ç”¨ç†è®ºè®²æˆã€æ¡ˆä¾‹åˆ†æã€å®è·µæ“ä½œã€å°ç»„è®¨è®ºã€é¡¹ç›®é©±åŠ¨ç­‰å¤šç§æ•™å­¦æ–¹æ³•ï¼Œç»“åˆçº¿ä¸Šçº¿ä¸‹æ··åˆå¼æ•™å­¦ï¼Œè¿ç”¨ç°ä»£ä¿¡æ¯æŠ€æœ¯æ‰‹æ®µæå‡æ•™å­¦æ•ˆæœã€‚',
        'æ•™å­¦åŠå‚è€ƒèµ„æ–™': f'1. ã€Š{course_name}ã€‹æƒå¨æ•™æï¼Œé«˜ç­‰æ•™è‚²å‡ºç‰ˆç¤¾\n2. ç›¸å…³æŠ€æœ¯æ–‡æ¡£å’Œè¡Œä¸šæ ‡å‡†\n3. åœ¨çº¿å­¦ä¹ èµ„æºå’Œè§†é¢‘æ•™ç¨‹\n4. å®é™…é¡¹ç›®æ¡ˆä¾‹å’Œä¼ä¸šå®è·µèµ„æ–™',
        'è¯¾ç¨‹ç¼–ç ': 'CS001',
        'å­¦æ—¶': '72',
        'å­¦åˆ†': '4',
        'è¯¾ç¨‹ç±»åˆ«': 'ä¸“ä¸šæ ¸å¿ƒè¯¾',
        'é€‚ç”¨ä¸“ä¸š': 'è®¡ç®—æœºç±»ä¸“ä¸š',
        # å®Œæ•´çš„8ä¸ªæ•™å­¦æ¨¡å—
        'æ•™å­¦æ¨¡å—1': 'åŸºç¡€ç†è®ºä¸æ¦‚å¿µ',
        'æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹1': f'é‡ç‚¹ï¼š{course_name}åŸºæœ¬æ¦‚å¿µã€ç†è®ºåŸºç¡€ã€æ ¸å¿ƒåŸç†ï¼›éš¾ç‚¹ï¼šç†è®ºä¸å®è·µçš„ç»“åˆï¼Œæ¦‚å¿µçš„æ·±å…¥ç†è§£ã€‚',
        'èŒä¸šæŠ€èƒ½è¦æ±‚1': 'ç†è§£å’ŒæŒæ¡åŸºç¡€ç†è®ºçŸ¥è¯†',
        'è¯¾æ—¶1': '8å­¦æ—¶',
        'æ•™å­¦æ–¹æ³•å»ºè®®1': 'ç†è®ºè®²æˆç»“åˆæ¡ˆä¾‹åˆ†æ',
        
        'æ•™å­¦æ¨¡å—2': 'æ ¸å¿ƒæŠ€æœ¯ä¸æ–¹æ³•',
        'æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹2': f'é‡ç‚¹ï¼š{course_name}æ ¸å¿ƒæŠ€æœ¯ã€ä¸»è¦æ–¹æ³•ã€æŠ€æœ¯è·¯çº¿ï¼›éš¾ç‚¹ï¼šæŠ€æœ¯åŸç†çš„æŒæ¡å’Œçµæ´»è¿ç”¨ã€‚',
        'èŒä¸šæŠ€èƒ½è¦æ±‚2': 'ç†Ÿç»ƒæŒæ¡æ ¸å¿ƒæŠ€æœ¯å’Œæ–¹æ³•',
        'è¯¾æ—¶2': '10å­¦æ—¶',
        'æ•™å­¦æ–¹æ³•å»ºè®®2': 'æŠ€æœ¯æ¼”ç¤ºç»“åˆå®è·µæ“ä½œ',
        
        'æ•™å­¦æ¨¡å—3': 'å®è·µåº”ç”¨ä¸æ“ä½œ',
        'æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹3': f'é‡ç‚¹ï¼š{course_name}å®é™…åº”ç”¨ã€æ“ä½œæŠ€èƒ½ã€å®è·µç¯èŠ‚ï¼›éš¾ç‚¹ï¼šç†è®ºçŸ¥è¯†å‘å®è·µæŠ€èƒ½çš„è½¬åŒ–ã€‚',
        'èŒä¸šæŠ€èƒ½è¦æ±‚3': 'å…·å¤‡ç‹¬ç«‹æ“ä½œå’Œåº”ç”¨èƒ½åŠ›',
        'è¯¾æ—¶3': '10å­¦æ—¶',
        'æ•™å­¦æ–¹æ³•å»ºè®®3': 'å®è·µæ“ä½œç»“åˆæŒ‡å¯¼è®­ç»ƒ',
        
        'æ•™å­¦æ¨¡å—4': 'é¡¹ç›®å¼€å‘ä¸è®¾è®¡',
        'æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹4': f'é‡ç‚¹ï¼š{course_name}é¡¹ç›®è®¾è®¡æ–¹æ³•ã€å¼€å‘æµç¨‹ã€è®¾è®¡åŸåˆ™ï¼›éš¾ç‚¹ï¼šç»¼åˆè¿ç”¨çŸ¥è¯†è¿›è¡Œé¡¹ç›®è®¾è®¡ã€‚',
        'èŒä¸šæŠ€èƒ½è¦æ±‚4': 'å…·å¤‡é¡¹ç›®è®¾è®¡å’Œå¼€å‘èƒ½åŠ›',
        'è¯¾æ—¶4': '10å­¦æ—¶',
        'æ•™å­¦æ–¹æ³•å»ºè®®4': 'é¡¹ç›®é©±åŠ¨æ•™å­¦æ³•',
        
        'æ•™å­¦æ¨¡å—5': 'æ¡ˆä¾‹åˆ†æä¸ç ”ç©¶',
        'æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹5': f'é‡ç‚¹ï¼š{course_name}å…¸å‹æ¡ˆä¾‹åˆ†æã€é—®é¢˜ç ”ç©¶æ–¹æ³•ï¼›éš¾ç‚¹ï¼šæ¡ˆä¾‹åˆ†æèƒ½åŠ›å’Œæ‰¹åˆ¤æ€§æ€ç»´çš„åŸ¹å…»ã€‚',
        'èŒä¸šæŠ€èƒ½è¦æ±‚5': 'å…·å¤‡æ¡ˆä¾‹åˆ†æå’Œç ”ç©¶èƒ½åŠ›',
        'è¯¾æ—¶5': '8å­¦æ—¶',
        'æ•™å­¦æ–¹æ³•å»ºè®®5': 'æ¡ˆä¾‹æ•™å­¦æ³•ç»“åˆå°ç»„è®¨è®º',
        
        'æ•™å­¦æ¨¡å—6': 'ç»¼åˆå®è®­ä¸è€ƒæ ¸',
        'æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹6': f'é‡ç‚¹ï¼š{course_name}ç»¼åˆå®è®­é¡¹ç›®ã€æŠ€èƒ½è€ƒæ ¸æ ‡å‡†ï¼›éš¾ç‚¹ï¼šç»¼åˆæŠ€èƒ½çš„æ•´åˆå’Œåº”ç”¨ã€‚',
        'èŒä¸šæŠ€èƒ½è¦æ±‚6': 'è¾¾åˆ°ç»¼åˆåº”ç”¨æŠ€èƒ½æ ‡å‡†',
        'è¯¾æ—¶6': '10å­¦æ—¶',
        'æ•™å­¦æ–¹æ³•å»ºè®®6': 'ç»¼åˆå®è®­ç»“åˆæŠ€èƒ½è€ƒæ ¸',
        
        'æ•™å­¦æ¨¡å—7': 'å‰æ²¿æŠ€æœ¯ä¸å‘å±•',
        'æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹7': f'é‡ç‚¹ï¼š{course_name}å‰æ²¿æŠ€æœ¯å‘å±•ã€æ–°æŠ€æœ¯åº”ç”¨ã€è¡Œä¸šè¶‹åŠ¿ï¼›éš¾ç‚¹ï¼šæ–°æŠ€æœ¯çš„ç†è§£å’Œåº”ç”¨å‰æ™¯åˆ†æã€‚',
        'èŒä¸šæŠ€èƒ½è¦æ±‚7': 'äº†è§£è¡Œä¸šå‘å±•å’Œæ–°æŠ€æœ¯è¶‹åŠ¿',
        'è¯¾æ—¶7': '8å­¦æ—¶',
        'æ•™å­¦æ–¹æ³•å»ºè®®7': 'ä¸“é¢˜è®²åº§ç»“åˆæŠ€æœ¯è°ƒç ”',
        
        'æ•™å­¦æ¨¡å—8': 'æ€»ç»“æå‡ä¸æ‹“å±•',
        'æ•™å­¦å†…å®¹åŠé‡ç‚¹ã€éš¾ç‚¹8': f'é‡ç‚¹ï¼š{course_name}çŸ¥è¯†ä½“ç³»æ€»ç»“ã€èƒ½åŠ›æå‡è·¯å¾„ã€å­¦ä¹ æ‹“å±•æ–¹å‘ï¼›éš¾ç‚¹ï¼šçŸ¥è¯†æ•´åˆå’Œèƒ½åŠ›æå‡è§„åˆ’ã€‚',
        'èŒä¸šæŠ€èƒ½è¦æ±‚8': 'å½¢æˆå®Œæ•´çš„çŸ¥è¯†æŠ€èƒ½ä½“ç³»',
        'è¯¾æ—¶8': '8å­¦æ—¶',
        'æ•™å­¦æ–¹æ³•å»ºè®®8': 'æ€»ç»“äº¤æµç»“åˆå­¦ä¹ è§„åˆ’',
        
        'æ€»è¯¾æ—¶': '72å­¦æ—¶'
    }